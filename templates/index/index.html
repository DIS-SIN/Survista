{% extends 'base.html' %}

{% block title %}Survista Index {% endblock %}

{% block styling %} 
<style>
    .align-center{
        justify-content: center;
        flex-grow: 1;
        flex-shrink: 0;
    }
</style>
{% endblock %}
{% block scripts %}
<script>
 $USER_STATUS = "{{g.user_status}}"
</script>
<script>
   (function(){
       console.log($USER_STATUS);
   })(document, window);
</script>
{% endblock %}

{%block menu_options %}
<li class="nav-item">
    <a class="nav-link active" href="{{url_for('index.index')}}">Home</a>
</li>
{% endblock %}

{% block user_actions %}
<li class="nav-item">
    <a class="nav-link" href='{{url_for("auth.logout")}}'>Logout<span class="sr-only">(current)</span></a>
</li>
{% endblock %}
{%block header %} <h2>Welcome to Survista</h2> {% endblock %}
{%block content %}

<div class = "row align-center" >
     <div class = "col col-md-10">
         <div class="card text-left">
           <div class="card-body">
             <h4 class="card-title">Title</h4>
             {% with messages = get_flashed_messages() %}
                 {% if messages %}
                  <div class = "messages">
                   {% for message in messages %}
                      <p class = "card-text">{{ message }}</p>
                   {% endfor %}
                  </div>
                  {% endif %}
              {% endwith %}
             <form method="POST" enctype=multipart/form-data>
                <div class="form-group">
                    <label for="survey_data"> Survey data file</label>
                    <input type="file" class="form-control-file" name="survey_data" id="surveyData" placeholder="surveydata.zip" aria-describedby="fileHelpId" required>
                    <small id="fileHelpId" class="form-text text-muted">Upload your survey data here... it must be a zip file with the predifined structure</small>
                </div>
                <div class="form-group" enctype = "multipart/form-data">
                    <label for="name_change">Enter an optional different filename for your file</label>
                    <input type="text" class="form-control" name="name_change" id="nameChange" aria-describedby="helpId">
                    <small id="helpId" class="form-text text-muted">Help text</small>
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
             </form>
           </div>
         </div>
     </div>
</div>
<br>
<br>
<br>
<div class = "row align-center">
   <div class = "col col-md-10">
        <h4>Resource Statuses</h4>
        <br>
        <a href="{{url_for('index.index')}}" class="btn btn-info btn-md">
            <i class="fas fa-sync-alt"></i> Refresh
        </a>
       <table class="table">
           <thead>
               <tr>
                   <th>Survey ID</th>
                   <th>Survey Name</th>
                   <th>File name</th>
                   <th>Status</th>
                   <th>Date Last Processed</th>
                   {% if g.user_status == 'owner' or g.user_status == 'admin' %}
                   <th>Actions</th>
                   {% endif %}
               </tr>
           </thead>
           <tbody>
               {% if g.surveys != None %}
                   {% for row in g.surveys %}
                      <tr>
                      <td scope="row">{{row['id']}}</td>
                      {% if row['survey_name'] != row['raw_data_path']%}
                          <td> {{row['survey_name']}}</td>
                      {% else %}
                          <td style = "color: yellow"> Fetching Data</td>
                      {% endif %}
                      <td> {{row['filename']}}</td>
                      {%if row['status'] == 'completed' %}
                         <td style = "color:green"> completed</td>
                      {%elif row['status'] == 'processing' %}
                         <td style ="color: yellow">processing</td>
                      {%else %}
                         <td style = "color: red">Error</td>
                      {% endif %}
                      <td> {{row['processing_date']}} UTC</td>
                      {% if g.user_status == 'owner' or g.user_status == 'admin' %}
                      <td>
                        <button name = "reprocess" type="button" class="btn btn-primary btn-sm" value= "{{row['id']}}" >Reprocess </button>
                        <button name = "delete" type="button" style = "background-color: red; border-color: red;" class="btn btn-primary btn-sm" value = "{{row['id']}}">Delete </button>
                      </td>
                      {% endif %}
                      </tr>
                   {% endfor %}
               {% endif %}
           </tbody>
       </table>
   </div>    
</div>
</div>
{% endblock %}

